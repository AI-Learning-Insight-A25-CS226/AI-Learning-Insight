openapi: 3.0.3
info:
  title: AI Learning Insight API (with ML)
  version: 1.0.0
  description: |
    RESTful API untuk aplikasi **AI Learning Insight**, terintegrasi dengan FastAPI ML Service.
    Mendukung autentikasi JWT, manajemen metrics pengguna, dan integrasi prediksi insight gaya belajar.

servers:
  - url: http://localhost:5000
    description: Local development server

components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  schemas:
    User:
      type: object
      properties:
        id: { type: integer, example: 1 }
        email: { type: string, example: "user@mail.com" }
        name: { type: string, example: "User Example" }

    Metrics:
      type: object
      properties:
        study_hours: { type: number, example: 3.5 }
        attendance: { type: number, example: 92 }
        assignment_completion: { type: number, example: 85 }
        motivation: { type: number, example: 4 }
        stress_level: { type: number, example: 2 }
        discussions: { type: number, example: 6 }
        resources: { type: number, example: 9 }

    Insight:
      type: object
      properties:
        student_id: { type: string, example: "1" }
        label: { type: string, example: "Consistent Learner" }
        confidence: { type: string, example: "0.8000" }
        cluster_id: { type: integer, example: 1 }
        reasons:
          type: array
          items:
            type: object
            properties:
              key: { type: string, example: "study_hours" }
              op: { type: string, example: ">=" }
              value: { type: number, example: 3 }

paths:
  /auth/register:
    post:
      summary: Register user baru
      tags: [Auth]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                email: { type: string }
                password: { type: string }
                name: { type: string }
              example:
                email: user@mail.com
                password: secret123
                name: User Example
      responses:
        "201":
          description: Registrasi berhasil
        "400":
          description: Bad request

  /auth/login:
    post:
      summary: Login untuk mendapatkan token JWT
      tags: [Auth]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                email: { type: string }
                password: { type: string }
              example:
                email: user@mail.com
                password: secret123
      responses:
        "200":
          description: Login berhasil, mengembalikan access token
        "401":
          description: Kredensial salah

  /auth/me:
    get:
      summary: Mendapatkan data user saat ini
      security:
        - BearerAuth: []
      tags: [Auth]
      responses:
        "200":
          description: Data user saat ini
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/User'
        "401":
          description: Token tidak valid

  /users/{userId}/metrics:
    get:
      summary: Melihat metrics user
      security:
        - BearerAuth: []
      tags: [Metrics]
      parameters:
        - name: userId
          in: path
          required: true
          schema: { type: string }
      responses:
        "200":
          description: Metrics berhasil diambil
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Metrics'
    put:
      summary: Update atau buat metrics baru
      security:
        - BearerAuth: []
      tags: [Metrics]
      parameters:
        - name: userId
          in: path
          required: true
          schema: { type: string }
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/Metrics'
      responses:
        "200":
          description: Metrics berhasil diperbarui

  /users/{userId}/metrics/recompute:
    post:
      summary: Hitung ulang metrics berdasarkan data mentah
      security:
        - BearerAuth: []
      tags: [Metrics]
      parameters:
        - name: userId
          in: path
          required: true
          schema: { type: string }
      responses:
        "200":
          description: Metrics berhasil dihitung ulang

  /users/{userId}/insights:
    post:
      summary: Prediksi insight gaya belajar baru (terhubung dengan ML service)
      security:
        - BearerAuth: []
      tags: [Insights]
      parameters:
        - name: userId
          in: path
          required: true
          schema: { type: string }
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                features:
                  $ref: '#/components/schemas/Metrics'
      responses:
        "200":
          description: Prediksi insight berhasil
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Insight'
    get:
      summary: Mendapatkan insight terbaru user
      security:
        - BearerAuth: []
      tags: [Insights]
      parameters:
        - name: userId
          in: path
          required: true
          schema: { type: string }
      responses:
        "200":
          description: Insight terakhir berhasil diambil
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Insight'